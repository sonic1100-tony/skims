# istio 환경 구성
## istio 설치

 #### Download Istio

```
$ curl -L https://istio.io/downloadIstio | sh -

$ cd istio-1.15.0
$ export PATH=$PWD/bin:$PATH 
$ echo "export PATH=$PWD/bin:$PATH" >> ~/.bashrc
$ source ~/.bashrc
$ istioctl
Istio configuration command line utility for service operators to
debug and diagnose their Istio mesh.

Usage:
  istioctl [command]

Available Commands:
  admin                Manage control plane (istiod) configuration
  analyze              Analyze Istio configuration and print validation messages
  authz                (authz is experimental. Use `istioctl experimental authz`)
  bug-report           Cluster information and log capture support tool.
  ~~~~~~~~~~~~~~~~~

```
##### 특정 버전 설치 시
```
$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.15.0 TARGET_ARCH=x86_64 sh -
```

#### Deploy the Istio operator
```
$ istioctl operator init
Operator controller is already installed in istio-operator namespace.
Upgrading operator controller in namespace: istio-operator using image: docker.io/istio/operator:1.15.0
Operator controller will watch namespaces: istio-system
✔ Istio operator installed
✔ Installation complete
```

#### Install Istio with the operator
 operator용 istio-operator.yaml 파일 작성, profile은 demo사용
 
 ```yml
 apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
  name: example-istiocontrolplane
spec:
  profile: demo
 ```
 
 yaml파일 실행
```bash
$ kubectl apply -f istio-operator.yaml
```

설치 완료 화면

![image](https://user-images.githubusercontent.com/85547822/189452018-28b6c244-538c-490d-afc7-b2c7f4a320c1.png)

프로파일별 component 
![image](https://user-images.githubusercontent.com/85547822/189562581-7d1c0d5f-ecb8-4ea4-9cfd-d02d65db5477.png)

istio resource 변경은 yaml수정 후 실행
```yml
 apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
  name: example-istiocontrolplane
spec:
  profile: demo
    components:                          # cpu, memory
    ingressGateways:
    - name: istio-ingressgateway
      enabled: true
      k8s:
        resources:
          requests:
            cpu: 20m
            memory: 50Mi
```
```bash
 $ kubectl apply -f istio-operator.yaml
istiooperator.install.istio.io/example-istiocontrolplane configured
```

***

#### 사이드카 인젝션
nginx-deply.yaml 파일 실행시 적용 방법
```bash
$ $ istioctl kube-inject -f nginx-deply.yaml | kubectl apply -f -
$ kubectl get pod
NAME                                READY   STATUS        RESTARTS   AGE   
nginx-deployment-66b6c48dd5-9mff9   0/1     Terminating   0          50s
nginx-deployment-6ddc564f6c-j5mqq   2/2     Running       0          5s
$ kubectl get pod
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-6ddc564f6c-j5mqq   2/2     Running   0          37s


```

namespace 라벨에 적용하는 방법

![image](https://user-images.githubusercontent.com/85547822/189566266-84692635-40a4-4a5a-8457-a7bcb3a5bdcb.png)


```
$ kubectl label namespaces default istio-injection=enable --
namespace/default labeled
```

**istio-injection=enable** 확인
```
$ kubectl get namespaces --show-labels
NAME              STATUS   AGE     LABELS
default           Active   19d     istio-injection=enable,kubernetes.io/metadata.name=default
istio-operator    Active   2d12h   kubernetes.io/metadata.name=istio-operator
istio-system      Active   2d12h   kubernetes.io/metadata.name=istio-system
kube-node-lease   Active   19d     kubernetes.io/metadata.name=kube-node-lease
kube-public       Active   19d     kubernetes.io/metadata.name=kube-public
kube-system       Active   19d     kubernetes.io/metadata.name=kube-system
skims-core        Active   5d17h   kubernetes.io/metadata.name=skims-core
```

namespace label 적용 후 injection 제외 pod 설정    
nginx-deply.yaml 파일에 **sidecar.istio.io/inject: "false"** 추가
```
  template:
    metadata:
      labels:
        app: nginx
        sidecar.istio.io/inject: "false"  # injection 제외
```

injection label 제거
```bash
$ kubectl label namespaces default istio-injection-
```




