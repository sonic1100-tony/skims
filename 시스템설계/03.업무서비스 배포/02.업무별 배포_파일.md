## jenkins 서버 workspace 구성
파일 경로 : /var/lib/jenkins/workspace

![image](https://user-images.githubusercontent.com/85547822/199891839-ac8fc9b9-ab35-4954-87c3-c9f7cc179e9f.png)

#### 서비스별 디렉토리 구조 설명(예:cnr)
```
buntu@ip-10-0-10-35:/var/lib/jenkins/workspace/skims-cnr$ ls -al
total 28
drwxr-xr-x  3 jenkins jenkins 4096 Oct 26 23:45 .
drwxr-xr-x 25 jenkins jenkins 4096 Oct 26 23:04 ..
-rw-rw-r--  1 jenkins jenkins  536 Sep 27 20:16 IgdFeignClient.java
-rwxrwxr-x  1 jenkins jenkins 1706 Sep 30 15:01 cnr-build.sh                    # build 파일
-rw-rw-r--  1 jenkins jenkins  871 Sep 30 13:31 cnr-deployment-template.yaml    # 환경변수용 temp 파일
-rw-rw-r--  1 jenkins jenkins  857 Oct 26 23:48 cnr-deployment.yaml             # 환경 변수 적용한 배포 파일
drwxr-xr-x 17 jenkins jenkins 4096 Oct 26 23:45 skims                           # git clone으로 다운로드한 원본 소스

```
#### cnr_build.sh
```
#!/bin/bash
#------------------------------------------------------------------------------------------
# Build 스크립트
#------------------------------------------------------------------------------------------

# gateway URL 변경
sed -i 's/localhost:8081/service-skims-igd-api.default.svc.cluster.local:8080/gi' skims/skimscnr/src/main/java/com/skims/client/IgdFeignClient.java
echo 'IgdFeignClient.java File modify (localhost:8081 --> service-skims-igd-api.default.svc.cluster.local:8080)'

#-- ECR정보
ECR=504441673365.dkr.ecr.ap-northeast-2.amazonaws.com
build()
{
    cd $1
    ./gradlew clean                           #-- Clean
    ./gradlew bootJar                         #-- Package Build
    docker build -t $ECR/$1:ver-$2 .              #-- Docker 이미지 생성
    docker push $ECR/$1:ver-$2                    #-- Docker 이미지 Push
    cd ..
}

ver=latest                                    #-- 기본버전은latest
if [ $# -gt 0 ]                               #-- 버전정보만 입력시 ./build.sh v2
then
    ver=$1
fi

cd skims

git pull

if [ $# -gt 1 ]                               #-- 특정 패키지 시 ./build.sh gateway v2
then
    build $1 $2
else                                          #-- 전체 패키지 생성
    for pkg in `echo gateway skimscnr skimscus skimsfin skimsigd skimspay skimspln skimsudw`
    do
        echo ------ $pkg build start `date`
        build $pkg $ver
        echo ------ $pkg build end `date`
    done
    cd frontend
    docker build -t $ECR/frontend:$ver .              #-- Docker 이미지 생성
    docker push $ECR/frontend:$ver                    #-- Docker 이미지 Push
    cd ..
fi

cd ..
```


#### cnr-deployment-template.yaml
```
##################################################################################################
# skimscnr service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-cnr-api
  labels:
    app: skims-cnr-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-cnr-api
  template:
    metadata:
      labels:
        app: skims-cnr-api
    spec:
      containers:
      - name: skims-cnr-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimscnr:ver-${BUILD_NUMBER}  # version number 변경됨
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-cnr-api
spec:
  selector:
    app: skims-cnr-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080

```

#### cnr-deployment.yaml
```
##################################################################################################
# skimscnr service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-cnr-api
  labels:
    app: skims-cnr-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-cnr-api
  template:
    metadata:
      labels:
        app: skims-cnr-api
    spec:
      containers:
      - name: skims-cnr-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimscnr:ver-3  # version number 변경됨
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-cnr-api
spec:
  selector:
    app: skims-cnr-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
    
```




## 업무별 Deployment & service

#### frontend-deployment.yaml
```yaml
##################################################################################################
# skimsfrontend service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-frontend-api
  labels:
    app: skims-frontend-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-frontend-api
  template:
    metadata:
      labels:
        app: skims-frontend-api
    spec:
      containers:
      - name: skims-frontend-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/frontend:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-frontend-api
spec:
  selector:
    app: skims-frontend-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### cnr-deployment.yaml
```yaml
##################################################################################################
# skimscnr service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-cnr-api
  labels:
    app: skims-cnr-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-cnr-api
  template:
    metadata:
      labels:
        app: skims-cnr-api
    spec:
      containers:
      - name: skims-cnr-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimscnr:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-cnr-api
spec:
  selector:
    app: skims-cnr-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### cus-deployment.yaml
```yaml
##################################################################################################
# skimscus service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-cus-api
  labels:
    app: skims-cus-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-cus-api
  template:
    metadata:
      labels:
        app: skims-cus-api
    spec:
      containers:
      - name: skims-cus-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimscus:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-cus-api
spec:
  selector:
    app: skims-cus-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### fin-deployment.yaml
```yaml
##################################################################################################
# skimsfin service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-fin-api
  labels:
    app: skims-fin-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-fin-api
  template:
    metadata:
      labels:
        app: skims-fin-api
    spec:
      containers:
      - name: skims-fin-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimsfin:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-fin-api
spec:
  selector:
    app: skims-fin-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### igd-deployment.yaml
```yaml
##################################################################################################
# skimsigd service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-igd-api
  labels:
    app: skims-igd-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-igd-api
  template:
    metadata:
      labels:
        app: skims-igd-api
    spec:
      containers:
      - name: skims-igd-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimsigd:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-igd-api
spec:
  selector:
    app: skims-igd-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### igd-deployment.yaml
```yaml
##################################################################################################
# skimspay service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-pay-api
  labels:
    app: skims-pay-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-pay-api
  template:
    metadata:
      labels:
        app: skims-pay-api
    spec:
      containers:
      - name: skims-pay-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimspay:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-pay-api
spec:
  selector:
    app: skims-pay-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### pln-deployment.yaml
```yaml
##################################################################################################
# skimspln service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-pln-api
  labels:
    app: skims-pln-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-pln-api
  template:
    metadata:
      labels:
        app: skims-pln-api
    spec:
      containers:
      - name: skims-pln-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimspln:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-pln-api
spec:
  selector:
    app: skims-pln-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```

#### udw-deployment.yaml
```yaml
##################################################################################################
# skimsudw service
##################################################################################################

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skims-udw-api
  labels:
    app: skims-udw-api    
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skims-udw-api
  template:
    metadata:
      labels:
        app: skims-udw-api
    spec:
      containers:
      - name: skims-udw-api
        image: 504441673365.dkr.ecr.ap-northeast-2.amazonaws.com/skimsudw:ver-${BUILD_NUMBER}
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: service-skims-udw-api
spec:
  selector:
    app: skims-udw-api
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080


```
